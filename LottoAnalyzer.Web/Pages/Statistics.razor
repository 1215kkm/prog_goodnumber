@page "/statistics"

<PageTitle>통계 분석 - 로또 분석기</PageTitle>

<!-- 최근 당첨번호 (Sticky) -->
@if (LatestResult != null)
{
    <div class="sticky-latest-result">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span style="color: #ff6b35; font-weight: bold; font-size: 13px;">@(LatestResult.Round)회</span>
            @foreach (var num in LatestResult.Numbers)
            {
                <LottoBall Number="@num" Small="true" />
            }
            <span style="color: #666; font-size: 14px;">+</span>
            <LottoBall Number="@LatestResult.BonusNumber" Small="true" />
        </div>
    </div>
}

<div class="container">
    <h1 style="margin-bottom: 20px;">통계 분석</h1>

    @if (!IsDataLoaded)
    {
        <div class="card" style="text-align: center; padding: 40px;">
            <p>분석 기간을 선택하세요.</p>
            <div style="margin: 20px 0;">
                <label style="margin-right: 10px; font-weight: bold;">분석 기간:</label>
                <select @bind="SelectedYears" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; border: 2px solid #ddd;">
                    @for (int i = 1; i <= 10; i++)
                    {
                        <option value="@i">@(i)년치 (@(i * 52)회)</option>
                    }
                </select>
            </div>
            <button class="btn btn-primary" @onclick="LoadData">데이터 분석</button>
        </div>
    }
    else
    {
        <!-- 기간 변경 옵션 -->
        <div class="card" style="margin-bottom: 20px; padding: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <div>
                <strong>현재 분석: @(SelectedYears)년치 (@(TotalResultCount)회)</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select @bind="SelectedYears" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                    @for (int i = 1; i <= 10; i++)
                    {
                        <option value="@i">@(i)년</option>
                    }
                </select>
                <button class="btn btn-secondary" style="padding: 8px 15px;" @onclick="LoadData">다시 분석</button>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="tabs">
            <span class="tab @(ActiveTab == "overall" ? "active" : "")" @onclick='() => ActiveTab = "overall"'>전체 통계</span>
            <span class="tab @(ActiveTab == "monthly" ? "active" : "")" @onclick='() => ActiveTab = "monthly"'>월별 통계</span>
            <span class="tab @(ActiveTab == "seasonal" ? "active" : "")" @onclick='() => ActiveTab = "seasonal"'>계절별 통계</span>
            <span class="tab @(ActiveTab == "yearly" ? "active" : "")" @onclick='() => ActiveTab = "yearly"'>연도별 통계</span>
            <span class="tab @(ActiveTab == "patterns" ? "active" : "")" @onclick='() => ActiveTab = "patterns"'>패턴 분석</span>
        </div>

        <!-- 전체 통계 -->
        @if (ActiveTab == "overall")
        {
            <div class="card">
                <div class="card-header">전체 번호별 출현 빈도 (45개)</div>
                <div class="number-grid">
                    @foreach (var stat in AllStatistics.OrderBy(s => s.Number))
                    {
                        <div style="text-align: center; padding: 10px;">
                            <LottoBall Number="@stat.Number" Highlight="@IsLatestNumber(stat.Number)" />
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                @(stat.Count)회<br/>
                                @(stat.Percentage)%
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">핫 넘버 (최근 30회 빈출)</div>
                    @foreach (var num in HotNumbers)
                    {
                        <StatBar Rank="@(HotNumbers.IndexOf(num) + 1)" Number="@num.Number"
                                 Count="@num.Count" Percentage="@num.Percentage" />
                    }
                </div>
                <div class="card">
                    <div class="card-header">콜드 넘버 (최근 30회 저빈도)</div>
                    @foreach (var num in ColdNumbers)
                    {
                        <StatBar Rank="@(ColdNumbers.IndexOf(num) + 1)" Number="@num.Number"
                                 Count="@num.Count" Percentage="@num.Percentage" />
                    }
                </div>
            </div>
        }

        <!-- 월별 통계 -->
        @if (ActiveTab == "monthly")
        {
            <div class="grid grid-3">
                @foreach (var monthStat in MonthlyStatistics)
                {
                    <div class="card period-card">
                        <div class="period-title">@(monthStat.MonthName) (총 @(monthStat.TotalDraws)회)</div>
                        <div class="period-numbers">
                            @foreach (var num in monthStat.TopNumbers.Take(6))
                            {
                                <LottoBall Number="@num.Number" Small="true" Highlight="@IsLatestNumber(num.Number)" />
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- 계절별 통계 -->
        @if (ActiveTab == "seasonal")
        {
            <div class="grid grid-2">
                @foreach (var seasonStat in SeasonalStatistics)
                {
                    <div class="card period-card">
                        <div class="period-title">@(seasonStat.SeasonName) (총 @(seasonStat.TotalDraws)회)</div>
                        <p style="color: #666; margin-bottom: 10px;">가장 많이 나온 번호:</p>
                        <div class="period-numbers">
                            @foreach (var num in seasonStat.TopNumbers.Take(10))
                            {
                                <LottoBall Number="@num.Number" Small="true" Highlight="@IsLatestNumber(num.Number)" />
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- 연도별 통계 -->
        @if (ActiveTab == "yearly")
        {
            @foreach (var yearStat in YearlyStatistics)
            {
                <div class="card">
                    <div class="card-header">@(yearStat.Year)년 (총 @(yearStat.TotalDraws)회)</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        @foreach (var num in yearStat.TopNumbers)
                        {
                            <div style="text-align: center;">
                                <LottoBall Number="@num.Number" Highlight="@IsLatestNumber(num.Number)" />
                                <div style="font-size: 11px; color: #666;">@(num.Count)회</div>
                            </div>
                        }
                    </div>
                </div>
            }
        }

        <!-- 패턴 분석 -->
        @if (ActiveTab == "patterns")
        {
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">홀짝 비율</div>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px;">@OddEvenText</pre>
                </div>
                <div class="card">
                    <div class="card-header">고저 비율 (22 기준)</div>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px;">@HighLowText</pre>
                </div>
                <div class="card">
                    <div class="card-header">합계 분석</div>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px;">@SumRangeText</pre>
                </div>
                <div class="card">
                    <div class="card-header">연속 번호 패턴</div>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px;">@ConsecutiveText</pre>
                </div>
            </div>
        }
    }
</div>

@code {
    [Inject] public LottoDataService DataService { get; set; } = default!;
    [Inject] public StatisticsService StatisticsService { get; set; } = default!;

    private bool IsDataLoaded = false;
    private string ActiveTab = "overall";
    private int SelectedYears = 6; // 기본값 6년
    private int TotalResultCount = 0;
    private LottoResult? LatestResult;

    protected override void OnInitialized()
    {
        try
        {
            var results = DataService.GetSampleData();
            LatestResult = results.OrderByDescending(r => r.Round).FirstOrDefault();
        }
        catch { }
    }

    private List<NumberStatistics> AllStatistics = new();
    private List<NumberStatistics> HotNumbers = new();
    private List<NumberStatistics> ColdNumbers = new();
    private List<MonthlyStatistics> MonthlyStatistics = new();
    private List<SeasonalStatistics> SeasonalStatistics = new();
    private List<YearlyStatistics> YearlyStatistics = new();

    private string OddEvenText = "";
    private string HighLowText = "";
    private string SumRangeText = "";
    private string ConsecutiveText = "";

    private void LoadData()
    {
        var allResults = DataService.GetSampleData(SelectedYears);
        TotalResultCount = allResults.Count;

        AllStatistics = StatisticsService.CalculateOverallStatistics(allResults);
        HotNumbers = StatisticsService.AnalyzeHotNumbers(allResults, 30);
        ColdNumbers = StatisticsService.AnalyzeColdNumbers(allResults, 30);
        MonthlyStatistics = StatisticsService.CalculateMonthlyStatistics(allResults);
        SeasonalStatistics = StatisticsService.CalculateSeasonalStatistics(allResults);
        YearlyStatistics = StatisticsService.CalculateYearlyStatistics(allResults);

        // 패턴 분석
        var oddEven = StatisticsService.AnalyzeOddEvenRatio(allResults);
        OddEvenText = string.Join("\n", oddEven.Take(5).Select(r =>
            $"홀{r.Key.Split(':')[0]}:짝{r.Key.Split(':')[1]} → {r.Value}회 ({(double)r.Value / allResults.Count * 100:F1}%)"));

        var highLow = StatisticsService.AnalyzeHighLowRatio(allResults);
        HighLowText = string.Join("\n", highLow.Take(5).Select(r =>
            $"{r.Key} → {r.Value}회 ({(double)r.Value / allResults.Count * 100:F1}%)"));

        var sumRange = StatisticsService.AnalyzeSumRange(allResults);
        SumRangeText = $"최소: {sumRange.Min}\n최대: {sumRange.Max}\n평균: {sumRange.Average:F1}\n최다 구간: {sumRange.MostCommonRangeStart}~{sumRange.MostCommonRangeEnd}";

        var consecutive = StatisticsService.AnalyzeConsecutivePatterns(allResults);
        ConsecutiveText = string.Join("\n", consecutive.Select(p =>
            p.ConsecutiveCount == 0
                ? $"연속 없음 → {p.Occurrences}회 ({p.Percentage}%)"
                : $"{p.ConsecutiveCount}개 연속 → {p.Occurrences}회 ({p.Percentage}%)"));

        IsDataLoaded = true;
    }

    private bool IsLatestNumber(int number)
    {
        if (LatestResult == null) return false;
        return LatestResult.Numbers.Contains(number) || LatestResult.BonusNumber == number;
    }
}
