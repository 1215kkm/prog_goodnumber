@page "/ai-recommendations"

<PageTitle>AI íŒ¨í„´ ì¶”ì²œ - ë¡œë˜ ë¶„ì„ê¸°</PageTitle>

<!-- ìµœê·¼ ë‹¹ì²¨ë²ˆí˜¸ (Sticky) -->
@if (LatestResult != null)
{
    <div class="sticky-latest-result">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span style="color: #ff6b35; font-weight: bold; font-size: 13px;">@(LatestResult.Round)íšŒ</span>
            @foreach (var num in LatestResult.Numbers)
            {
                <LottoBall Number="@num" Small="true" />
            }
            <span style="color: #666; font-size: 14px;">+</span>
            <LottoBall Number="@LatestResult.BonusNumber" Small="true" />
        </div>
    </div>
}

<div class="container">
    <h1 style="margin-bottom: 10px;">AI íŒ¨í„´ ì¶”ì²œ</h1>
    <p style="color: #666; margin-bottom: 15px;">
        ë‹¤ì–‘í•œ í†µê³„ì  íŒ¨í„´ì„ ì¡°í•©í•œ ë²ˆí˜¸ ì¶”ì²œì…ë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.
    </p>
    <div style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: #fff; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; text-align: center;">
        ì‚¬ìš©ì€ ëˆ„êµ¬ë‚˜ ë¬´ë£Œ! ëŒ€ì‹  ë‹¹ì²¨ë˜ë©´ 1/3 ì£¼ì¸ì¥í•œí…Œ ë‚˜ëˆ ì£¼ë©´ ë©ë‹ˆë‹¤ ğŸ˜‰
    </div>

    <!-- ì „ëµ ì„¤ëª… ì¹´ë“œ -->
    <div class="card" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); border: 1px solid #444;">
        <div style="color: #fff; font-weight: bold; margin-bottom: 10px;">ë°±í…ŒìŠ¤íŠ¸ ì°¸ê³  ìˆ˜ì¹˜ (ê³¼ê±° 100íšŒ ê¸°ì¤€)</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #4CAF50; font-size: 20px; font-weight: bold;">1.670</div>
                <div style="color: #aaa; font-size: 11px;">í‰ê·  ì ì¤‘ ê°œìˆ˜</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #ff9800; font-size: 20px; font-weight: bold;">0.800</div>
                <div style="color: #aaa; font-size: 11px;">ëœë¤ ê¸°ëŒ€ê°’</div>
            </div>
        </div>
        <div style="color: #888; font-size: 11px; margin-top: 10px;">
            * ê³¼ê±° ë°ì´í„° ê¸°ë°˜ ìˆ˜ì¹˜ì´ë©°, ë¯¸ë˜ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" @onclick="GenerateRecommendations" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
            @if (IsLoading)
            {
                <span>íŒ¨í„´ ë¶„ì„ ì¤‘...</span>
            }
            else
            {
                <span>AI íŒ¨í„´ ì¶”ì²œ ìƒì„±</span>
            }
        </button>
    </div>

    @{
        var numberCounts = GetNumberAppearanceCounts();
        var commonNumbers = numberCounts.Where(kv => kv.Value >= 3).OrderByDescending(kv => kv.Value).ToList();
        var twoStrategyNumbers = numberCounts.Where(kv => kv.Value == 2).OrderByDescending(kv => kv.Key).ToList();
        var hasCommon = commonNumbers.Count > 0 || twoStrategyNumbers.Count > 0;
    }

    @if (Recommendations.Any())
    {
        <div style="margin-bottom: 15px; color: #666;">
            <strong>@(DataCount)íšŒì°¨ ë°ì´í„° ê¸°ë°˜ íŒ¨í„´ ë¶„ì„ ê²°ê³¼</strong>
        </div>

        @foreach (var rec in Recommendations)
        {
            <div class="card" style="margin-bottom: 15px; border-left: 4px solid @GetScoreColor(rec.BacktestScore);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                    <div>
                        <span style="font-weight: bold; font-size: 16px;">@rec.StrategyName</span>
                        <span style="background: @GetScoreColor(rec.BacktestScore); color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">
                            @(rec.BacktestScore.ToString("F3")) avg
                        </span>
                    </div>
                    <div style="font-size: 12px; color: #888;">
                        ì ì¤‘ë¥  @(rec.BacktestHit3)% | ëœë¤ ëŒ€ë¹„ +@(((rec.BacktestScore - 0.8) / 0.8 * 100).ToString("F0"))%
                    </div>
                </div>

                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">@rec.Description</p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    @foreach (var num in rec.Numbers)
                    {
                        <LottoBall Number="@num" />
                    }
                </div>

                <div style="font-size: 11px; color: #999; padding-top: 8px; border-top: 1px solid #eee;">
                    @rec.StrategyDetail
                </div>
            </div>
        }

        @if (hasCommon)
        {
            <div class="card" style="margin-bottom: 15px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #333;">
                <div style="color: #fff; font-weight: bold; margin-bottom: 12px;">ì „ëµ ê³µí†µ ë²ˆí˜¸</div>

                @if (commonNumbers.Any())
                {
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                        <div style="color: #4CAF50; font-size: 12px; margin-bottom: 8px; font-weight: bold;">
                            3ê°œ ì´ìƒ ì „ëµì—ì„œ ê³µí†µ ì¶”ì²œ
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            @foreach (var item in commonNumbers)
                            {
                                <div style="position: relative;">
                                    <LottoBall Number="@item.Key" />
                                    <span style="position: absolute; top: -6px; right: -6px; background: #4CAF50; color: #fff; font-size: 9px; padding: 1px 4px; border-radius: 8px;">@(item.Value)</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (twoStrategyNumbers.Any())
                {
                    <div style="padding: 10px; background: rgba(255, 152, 0, 0.15); border-radius: 8px;">
                        <div style="color: #ff9800; font-size: 12px; margin-bottom: 8px; font-weight: bold;">
                            2ê°œ ì „ëµì—ì„œ ê³µí†µ ì¶”ì²œ
                        </div>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            @foreach (var item in twoStrategyNumbers)
                            {
                                <LottoBall Number="@item.Key" Small="true" />
                            }
                        </div>
                    </div>
                }

                <div style="margin-top: 12px; color: #888; font-size: 11px;">
                    ì—¬ëŸ¬ ì „ëµì—ì„œ ê³µí†µìœ¼ë¡œ ì¶”ì²œëœ ë²ˆí˜¸ëŠ” ë‹¤ì–‘í•œ íŒ¨í„´ì—ì„œ ëª¨ë‘ ìœ ë§í•œ ë²ˆí˜¸ì…ë‹ˆë‹¤.
                </div>
            </div>
        }

        <div class="card" style="margin-top: 15px; background: #fff3e0; border: 1px solid #ffe0b2;">
            <p style="margin: 0; color: #e65100; font-size: 13px;">
                <strong>ì£¼ì˜:</strong> ì´ ì¶”ì²œì€ ê³¼ê±° ë°ì´í„°ì˜ íŒ¨í„´ ë¶„ì„ì— ê¸°ë°˜í•˜ë©°, ë‹¹ì²¨ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                ë¡œë˜ëŠ” ë¬´ì‘ìœ„ ì¶”ì²¨ì´ë¯€ë¡œ ì–´ë–¤ ì „ëµë„ í™•ì‹¤í•œ ìš°ìœ„ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
        </div>
    }
    else
    {
        <div class="card" style="text-align: center; padding: 40px;">
            <p style="color: #666;">ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI íŒ¨í„´ ì¶”ì²œ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
        </div>
    }
</div>

@code {
    [Inject] public LottoDataService DataService { get; set; } = default!;
    [Inject] public PatternRecommendationService PatternService { get; set; } = default!;

    private bool IsLoading = false;
    private List<PatternRecommendation> Recommendations = new();
    private int DataCount = 0;
    private LottoResult? LatestResult;

    protected override void OnInitialized()
    {
        try
        {
            var results = DataService.GetSampleData();
            LatestResult = results.OrderByDescending(r => r.Round).FirstOrDefault();
        }
        catch { }
    }

    private void GenerateRecommendations()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var allResults = DataService.GetSampleData(100); // ì „ì²´ ë°ì´í„° ì‚¬ìš©
            DataCount = allResults.Count;
            Recommendations = PatternService.GeneratePatternRecommendations(allResults);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Dictionary<int, int> GetNumberAppearanceCounts()
    {
        var counts = new Dictionary<int, int>();
        foreach (var rec in Recommendations)
        {
            foreach (var num in rec.Numbers)
            {
                if (counts.ContainsKey(num))
                    counts[num]++;
                else
                    counts[num] = 1;
            }
        }
        return counts;
    }

    private string GetScoreColor(double score)
    {
        if (score >= 1.65) return "#4CAF50";
        if (score >= 1.62) return "#ff9800";
        if (score >= 1.59) return "#2196F3";
        return "#9e9e9e";
    }
}
