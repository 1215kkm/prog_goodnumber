@page "/ai-recommendations"

<PageTitle>AI 패턴 추천 - 로또 분석기</PageTitle>

<!-- 최근 당첨번호 (Sticky) -->
@if (LatestResult != null)
{
    <div class="sticky-latest-result">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span style="color: #ff6b35; font-weight: bold; font-size: 13px;">@(LatestResult.Round)회</span>
            @foreach (var num in LatestResult.Numbers)
            {
                <LottoBall Number="@num" Small="true" />
            }
            <span style="color: #666; font-size: 14px;">+</span>
            <LottoBall Number="@LatestResult.BonusNumber" Small="true" />
        </div>
    </div>
}

<div class="container">
    <h1 style="margin-bottom: 10px;">AI 패턴 추천</h1>
    <p style="color: #666; margin-bottom: 20px;">
        조작 가설 기반 v6 백테스트로 최적화된 패턴 분석 전략입니다.
        랜덤 대비 <strong>+109%</strong> 적중률, <strong>5개 이상 적중 10%</strong>, 6개(1등) 2%를 달성합니다.
    </p>

    <!-- 전략 설명 카드 -->
    <div class="card" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); border: 1px solid #444;">
        <div style="color: #fff; font-weight: bold; margin-bottom: 10px;">조작 가설 기반 v6 백테스트 결과</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #4CAF50; font-size: 20px; font-weight: bold;">1.670</div>
                <div style="color: #aaa; font-size: 11px;">최고 평균적중</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #ff9800; font-size: 20px; font-weight: bold;">10%</div>
                <div style="color: #aaa; font-size: 11px;">5개+ 적중률</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #2196F3; font-size: 20px; font-weight: bold;">+109%</div>
                <div style="color: #aaa; font-size: 11px;">랜덤 대비</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="color: #e91e63; font-size: 20px; font-weight: bold;">2%</div>
                <div style="color: #aaa; font-size: 11px;">6개(1등) 적중</div>
            </div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" @onclick="GenerateRecommendations" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
            @if (IsLoading)
            {
                <span>패턴 분석 중...</span>
            }
            else
            {
                <span>AI 패턴 추천 생성</span>
            }
        </button>
    </div>

    @{
        var numberCounts = GetNumberAppearanceCounts();
        var commonNumbers = numberCounts.Where(kv => kv.Value >= 3).OrderByDescending(kv => kv.Value).ToList();
        var twoStrategyNumbers = numberCounts.Where(kv => kv.Value == 2).OrderByDescending(kv => kv.Key).ToList();
        var hasCommon = commonNumbers.Count > 0 || twoStrategyNumbers.Count > 0;
    }

    @if (Recommendations.Any())
    {
        <div style="margin-bottom: 15px; color: #666;">
            <strong>@(DataCount)회차 데이터 기반 패턴 분석 결과</strong>
        </div>

        @foreach (var rec in Recommendations)
        {
            <div class="card" style="margin-bottom: 15px; border-left: 4px solid @GetScoreColor(rec.BacktestScore);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                    <div>
                        <span style="font-weight: bold; font-size: 16px;">@rec.StrategyName</span>
                        <span style="background: @GetScoreColor(rec.BacktestScore); color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">
                            @(rec.BacktestScore.ToString("F3")) avg
                        </span>
                    </div>
                    <div style="font-size: 12px; color: #888;">
                        적중률 @(rec.BacktestHit3)% | 랜덤 대비 +@(((rec.BacktestScore - 0.8) / 0.8 * 100).ToString("F0"))%
                    </div>
                </div>

                <p style="color: #666; font-size: 13px; margin-bottom: 12px;">@rec.Description</p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    @foreach (var num in rec.Numbers)
                    {
                        <LottoBall Number="@num" />
                    }
                </div>

                <div style="font-size: 11px; color: #999; padding-top: 8px; border-top: 1px solid #eee;">
                    @rec.StrategyDetail
                </div>
            </div>
        }

        @if (hasCommon)
        {
            <div class="card" style="margin-bottom: 15px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #333;">
                <div style="color: #fff; font-weight: bold; margin-bottom: 12px;">전략 공통 번호</div>

                @if (commonNumbers.Any())
                {
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                        <div style="color: #4CAF50; font-size: 12px; margin-bottom: 8px; font-weight: bold;">
                            3개 이상 전략에서 공통 추천
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            @foreach (var item in commonNumbers)
                            {
                                <div style="position: relative;">
                                    <LottoBall Number="@item.Key" />
                                    <span style="position: absolute; top: -6px; right: -6px; background: #4CAF50; color: #fff; font-size: 9px; padding: 1px 4px; border-radius: 8px;">@(item.Value)</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (twoStrategyNumbers.Any())
                {
                    <div style="padding: 10px; background: rgba(255, 152, 0, 0.15); border-radius: 8px;">
                        <div style="color: #ff9800; font-size: 12px; margin-bottom: 8px; font-weight: bold;">
                            2개 전략에서 공통 추천
                        </div>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            @foreach (var item in twoStrategyNumbers)
                            {
                                <LottoBall Number="@item.Key" Small="true" />
                            }
                        </div>
                    </div>
                }

                <div style="margin-top: 12px; color: #888; font-size: 11px;">
                    여러 전략에서 공통으로 추천된 번호는 다양한 패턴에서 모두 유망한 번호입니다.
                </div>
            </div>
        }

        <div class="card" style="margin-top: 15px; background: #e8f5e9; border: 1px solid #c8e6c9;">
            <p style="margin: 0; color: #2e7d32; font-size: 13px;">
                <strong>참고:</strong> 이 추천은 조작 가설 기반으로 발견된 통계적 유의미 패턴에 기반합니다.
                ±3오프셋(17.6%), 보수(17.1%), LCG(18%), ±1회피 패턴을 활용합니다.
                백테스트에서 랜덤 대비 +109% 적중률, 6개(1등) 2%를 달성했으나 당첨을 보장하지 않습니다.
            </p>
        </div>
    }
    else
    {
        <div class="card" style="text-align: center; padding: 40px;">
            <p style="color: #666;">버튼을 클릭하여 AI 패턴 추천 번호를 생성하세요.</p>
        </div>
    }
</div>

@code {
    [Inject] public LottoDataService DataService { get; set; } = default!;
    [Inject] public PatternRecommendationService PatternService { get; set; } = default!;

    private bool IsLoading = false;
    private List<PatternRecommendation> Recommendations = new();
    private int DataCount = 0;
    private LottoResult? LatestResult;

    protected override void OnInitialized()
    {
        try
        {
            var results = DataService.GetSampleData();
            LatestResult = results.OrderByDescending(r => r.Round).FirstOrDefault();
        }
        catch { }
    }

    private void GenerateRecommendations()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var allResults = DataService.GetSampleData(100); // 전체 데이터 사용
            DataCount = allResults.Count;
            Recommendations = PatternService.GeneratePatternRecommendations(allResults);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Dictionary<int, int> GetNumberAppearanceCounts()
    {
        var counts = new Dictionary<int, int>();
        foreach (var rec in Recommendations)
        {
            foreach (var num in rec.Numbers)
            {
                if (counts.ContainsKey(num))
                    counts[num]++;
                else
                    counts[num] = 1;
            }
        }
        return counts;
    }

    private string GetScoreColor(double score)
    {
        if (score >= 1.65) return "#4CAF50";
        if (score >= 1.62) return "#ff9800";
        if (score >= 1.59) return "#2196F3";
        return "#9e9e9e";
    }
}
