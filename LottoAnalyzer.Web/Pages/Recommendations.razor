@page "/recommendations"

<PageTitle>AI 추천 번호 - 로또 분석기</PageTitle>

<!-- 최근 당첨번호 (Sticky) -->
@if (LatestResult != null)
{
    <div class="sticky-latest-result">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span style="color: #ff6b35; font-weight: bold; font-size: 13px;">@(LatestResult.Round)회</span>
            @foreach (var num in LatestResult.Numbers)
            {
                <LottoBall Number="@num" Small="true" />
            }
            <span style="color: #666; font-size: 14px;">+</span>
            <LottoBall Number="@LatestResult.BonusNumber" Small="true" />
        </div>
    </div>
}

<div class="container">
    <h1 style="margin-bottom: 10px;">AI 번호 추천</h1>
    <p style="color: #666; margin-bottom: 20px;">
        8가지 분석 알고리즘 기반 추천 번호입니다.
        <strong>매번 다른 조합</strong>이 생성됩니다.
    </p>

    <!-- 분석 기간 선택 -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <label style="font-weight: bold;">분석 기간:</label>
            <select @bind="SelectedYears" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@(i)년치 (@(i * 52)회)</option>
                }
            </select>
            <span style="color: #666; font-size: 14px;">
                * 짧은 기간: 최신 트렌드 반영 / 긴 기간: 장기 패턴 분석
            </span>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" @onclick="GenerateRecommendations">
            @if (IsLoading)
            {
                <span>추천 생성 중...</span>
            }
            else
            {
                <span>새로운 추천 번호 생성</span>
            }
        </button>
    </div>

    @if (RecommendationList.Any())
    {
        <div style="margin-bottom: 15px; color: #666;">
            <strong>@(SelectedYears)년치 데이터 (@(TotalResultCount)회) 기반 분석 결과</strong>
        </div>

        <div class="grid grid-2">
            @foreach (var rec in RecommendationList)
            {
                <RecommendationCard Recommendation="@rec" />
            }
        </div>

        <div class="card" style="margin-top: 20px; background: #fff3cd;">
            <p style="margin: 0; color: #856404;">
                <strong>알림:</strong> 이 추천은 과거 통계 분석에 기반하며, 당첨을 보장하지 않습니다.
                로또는 완전한 랜덤 추첨이므로 모든 번호가 동일한 확률을 가집니다.
            </p>
        </div>
    }
    else
    {
        <div class="card" style="text-align: center; padding: 40px;">
            <p style="color: #666;">버튼을 클릭하여 AI 추천 번호를 생성하세요.</p>
        </div>
    }
</div>

@code {
    [Inject] public LottoDataService DataService { get; set; } = default!;
    [Inject] public StatisticsService StatisticsService { get; set; } = default!;
    [Inject] public RecommendationService RecommendationService { get; set; } = default!;

    private bool IsLoading = false;
    private List<RecommendedNumbers> RecommendationList = new();
    private int SelectedYears = 6; // 기본값 6년
    private int TotalResultCount = 0;
    private LottoResult? LatestResult;

    protected override void OnInitialized()
    {
        try
        {
            var results = DataService.GetSampleData();
            LatestResult = results.OrderByDescending(r => r.Round).FirstOrDefault();
        }
        catch { }
    }

    private void GenerateRecommendations()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var allResults = DataService.GetSampleData(SelectedYears);
            TotalResultCount = allResults.Count;
            RecommendationList = RecommendationService.GenerateRecommendations(allResults);
        }
        finally
        {
            IsLoading = false;
        }
    }
}
