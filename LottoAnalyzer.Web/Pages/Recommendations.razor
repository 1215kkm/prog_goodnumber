@page "/recommendations"

<PageTitle>í†µê³„ ì¶”ì²œ ë²ˆí˜¸ - ë¡œë˜ ë¶„ì„ê¸°</PageTitle>

<!-- ìµœê·¼ ë‹¹ì²¨ë²ˆí˜¸ (Sticky) -->
@if (LatestResult != null)
{
    <div class="sticky-latest-result">
        <div class="container" style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span style="color: #ff6b35; font-weight: bold; font-size: 13px;">@(LatestResult.Round)íšŒ</span>
            @foreach (var num in LatestResult.Numbers)
            {
                <LottoBall Number="@num" Small="true" />
            }
            <span style="color: #666; font-size: 14px;">+</span>
            <LottoBall Number="@LatestResult.BonusNumber" Small="true" />
        </div>
    </div>
}

<div class="container">
    <h1 style="margin-bottom: 10px;">í†µê³„ ê¸°ë°˜ ì¶”ì²œ</h1>
    <p style="color: #666; margin-bottom: 20px;">
        8ê°€ì§€ í†µê³„ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ì¶”ì²œ ë²ˆí˜¸ì…ë‹ˆë‹¤.
        <strong>ë§¤ë²ˆ ë‹¤ë¥¸ ì¡°í•©</strong>ì´ ìƒì„±ë©ë‹ˆë‹¤.
    </p>

    <!-- ë¶„ì„ ê¸°ê°„ ì„ íƒ -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <label style="font-weight: bold;">ë¶„ì„ ê¸°ê°„:</label>
            <select @bind="SelectedYears" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@(i)ë…„ì¹˜ (@(i * 52)íšŒ)</option>
                }
            </select>
            <span style="color: #666; font-size: 14px;">
                * ì§§ì€ ê¸°ê°„: ìµœì‹  íŠ¸ë Œë“œ ë°˜ì˜ / ê¸´ ê¸°ê°„: ì¥ê¸° íŒ¨í„´ ë¶„ì„
            </span>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" @onclick="GenerateRecommendations">
            @if (IsLoading)
            {
                <span>ì¶”ì²œ ìƒì„± ì¤‘...</span>
            }
            else
            {
                <span>ìƒˆë¡œìš´ ì¶”ì²œ ë²ˆí˜¸ ìƒì„±</span>
            }
        </button>
    </div>

    @{
        var numberCounts = GetNumberAppearanceCounts();
        var commonNumbers = numberCounts.Where(kv => kv.Value >= 3).OrderByDescending(kv => kv.Value).ToList();
        var twoAlgoNumbers = numberCounts.Where(kv => kv.Value == 2).OrderByDescending(kv => kv.Key).ToList();
        var hasCommon = commonNumbers.Count > 0;
        var hasTwoAlgo = twoAlgoNumbers.Count > 0;
    }

    @if (RecommendationList.Any())
    {
        <div style="margin-bottom: 15px; color: #666;">
            <strong>@(SelectedYears)ë…„ì¹˜ ë°ì´í„° (@(TotalResultCount)íšŒ) ê¸°ë°˜ ë¶„ì„ ê²°ê³¼</strong>
        </div>

        <!-- ê³µí†µ ì¶”ì²œ ë²ˆí˜¸ ë¶„ì„ -->
        <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #333;">
            <div style="color: #fff; font-weight: bold; margin-bottom: 15px;">ğŸ¯ ì•Œê³ ë¦¬ì¦˜ ê³µí†µ ë¶„ì„</div>

            @if (hasCommon)
            {
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                    <div style="color: #4CAF50; font-size: 13px; margin-bottom: 8px; font-weight: bold;">
                        â­ 3ê°œ ì´ìƒ ì•Œê³ ë¦¬ì¦˜ì—ì„œ ì¶”ì²œ (í•µì‹¬ ë²ˆí˜¸)
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        @foreach (var item in commonNumbers)
                        {
                            <div style="position: relative;">
                                <LottoBall Number="@item.Key" />
                                <span style="position: absolute; top: -8px; right: -8px; background: #4CAF50; color: #fff; font-size: 10px; padding: 2px 5px; border-radius: 10px;">@(item.Value)íšŒ</span>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (hasTwoAlgo)
            {
                <div style="padding: 12px; background: rgba(255, 152, 0, 0.15); border-radius: 8px;">
                    <div style="color: #ff9800; font-size: 13px; margin-bottom: 8px; font-weight: bold;">
                        ğŸ“Œ 2ê°œ ì•Œê³ ë¦¬ì¦˜ì—ì„œ ì¶”ì²œ
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        @foreach (var item in twoAlgoNumbers)
                        {
                            <LottoBall Number="@item.Key" Small="true" />
                        }
                    </div>
                </div>
            }

            @if (!hasCommon && !hasTwoAlgo)
            {
                <div style="color: #888; text-align: center; padding: 10px;">
                    ëª¨ë“  ì•Œê³ ë¦¬ì¦˜ì´ ì„œë¡œ ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.
                </div>
            }

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; color: #888; font-size: 12px;">
                ğŸ’¡ ì—¬ëŸ¬ ì•Œê³ ë¦¬ì¦˜ì—ì„œ ê³µí†µìœ¼ë¡œ ì¶”ì²œëœ ë²ˆí˜¸ëŠ” ë‹¤ì–‘í•œ ë¶„ì„ ê¸°ì¤€ì—ì„œ ìœ ë§í•œ ë²ˆí˜¸ì…ë‹ˆë‹¤.
            </div>
        </div>

        <div class="grid grid-2">
            @foreach (var rec in RecommendationList)
            {
                <RecommendationCard Recommendation="@rec" />
            }
        </div>

        <div class="card" style="margin-top: 20px; background: #fff3cd;">
            <p style="margin: 0; color: #856404;">
                <strong>ì•Œë¦¼:</strong> ì´ ì¶”ì²œì€ ê³¼ê±° í†µê³„ ë¶„ì„ì— ê¸°ë°˜í•˜ë©°, ë‹¹ì²¨ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                ë¡œë˜ëŠ” ì™„ì „í•œ ëœë¤ ì¶”ì²¨ì´ë¯€ë¡œ ëª¨ë“  ë²ˆí˜¸ê°€ ë™ì¼í•œ í™•ë¥ ì„ ê°€ì§‘ë‹ˆë‹¤.
            </p>
        </div>
    }
    else
    {
        <div class="card" style="text-align: center; padding: 40px;">
            <p style="color: #666;">ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í†µê³„ ì¶”ì²œ ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
        </div>
    }
</div>

@code {
    [Inject] public LottoDataService DataService { get; set; } = default!;
    [Inject] public StatisticsService StatisticsService { get; set; } = default!;
    [Inject] public RecommendationService RecommendationService { get; set; } = default!;

    private bool IsLoading = false;
    private List<RecommendedNumbers> RecommendationList = new();
    private int SelectedYears = 6; // ê¸°ë³¸ê°’ 6ë…„
    private int TotalResultCount = 0;
    private LottoResult? LatestResult;

    protected override void OnInitialized()
    {
        try
        {
            var results = DataService.GetSampleData();
            LatestResult = results.OrderByDescending(r => r.Round).FirstOrDefault();
        }
        catch { }
    }

    private void GenerateRecommendations()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var allResults = DataService.GetSampleData(SelectedYears);
            TotalResultCount = allResults.Count;
            RecommendationList = RecommendationService.GenerateRecommendations(allResults);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Dictionary<int, int> GetNumberAppearanceCounts()
    {
        var counts = new Dictionary<int, int>();
        foreach (var rec in RecommendationList)
        {
            foreach (var num in rec.Numbers)
            {
                if (counts.ContainsKey(num))
                    counts[num]++;
                else
                    counts[num] = 1;
            }
        }
        return counts;
    }
}
